name: Test & Coverage Report

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test-and-coverage:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'
    
    - name: Find and list test projects
      run: |
        find MyDotNetSolution -name "*.Tests.csproj" -type f
    
    - name: Restore dependencies
      run: dotnet restore MyDotNetSolution/MyDotNetSolution.sln --skip-aspire-workload-check
    
    - name: Build (excluding AppHost)
      run: dotnet build MyDotNetSolution/MyDotNetSolution.sln --no-restore --configuration Release --skip-aspire-workload-check -p:SkipAspireWorkloadCheck=true 2>/dev/null || dotnet build MyDotNetSolution/src/MyDotNetApp/MyDotNetApp.csproj --no-restore --configuration Release
    
    - name: Run Tests with Coverage
      run: |
        dotnet test MyDotNetSolution/Tests/MyDotNetApp.Tests/MyDotNetApp.Tests.csproj \
          --configuration Release \
          --logger "console;verbosity=detailed" \
          /p:CollectCoverage=true \
          /p:CoverletOutputFormat=cobertura \
          /p:CoverletOutput=./coverage \
          /p:Exclude="[*Tests]*,[*ServiceDefaults]*" \
          --results-directory=TestResults
    
    - name: Find coverage file
      run: |
        find MyDotNetSolution -name "coverage.cobertura.xml" -type f
    
    - name: Generate Coverage Report
      if: success()
      run: |
        dotnet tool install -g ReportGenerator
        COVERAGE_FILE=$(find MyDotNetSolution -name "coverage.cobertura.xml" -type f | head -1)
        echo "Found coverage file: $COVERAGE_FILE"
        reportgenerator -reports:"$COVERAGE_FILE" \
          -targetdir:"docs/coverage" \
          -reporttypes:"Html;Badges" \
          -title:"Test Coverage Report"
    
    - name: Commit and push coverage report
      if: success()
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add docs/coverage/ 2>/dev/null || true
        git commit -m "ci: Update test coverage report" 2>/dev/null || true
        git push 2>/dev/null || true
    
    - name: Test Summary
      if: always()
      run: |
        echo "## Test & Coverage Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Tests executed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“Š Coverage Report: [View Coverage](https://dertnius.github.io/kafka-producer-balanced/#/coverage/)" >> $GITHUB_STEP_SUMMARY
